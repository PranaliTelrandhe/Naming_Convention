name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add Tools to PATH
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      - name: Generate build files with CMake
        run: |
          # 1. FIND the actual folder containing CMakeLists.txt
          $cmakeFile = Get-ChildItem -Recurse -Filter "CMakeLists.txt" | Select-Object -First 1

          if ($null -eq $cmakeFile) {
              Write-Error "ERROR: Could not find CMakeLists.txt in any subfolder!"
              exit 1
          }

          $sourceDir = $cmakeFile.DirectoryName
          Write-Host "Target Source Directory: $sourceDir"

          # 2. JUMP into that directory
          cd $sourceDir

          # 3. Clean and Run CMake locally in that folder
          if (Test-Path "build") { Remove-Item -Recurse -Force -ErrorAction SilentlyContinue "build" }

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_C_COMPILER=gcc `
            -DCMAKE_CXX_COMPILER=g++ `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        shell: powershell

      - name: Build project
        run: |
          # 1. Again, find the build directory
          $buildDir = (Get-ChildItem -Recurse -Directory -Filter "build" | Select-Object -First 1).FullName
          Write-Host "Building in: $buildDir"

          # 2. Run the build command pointing to that folder
          cmake --build "$buildDir"
        shell: powershell

      - name: Run executable
        run: |
          # Look for the .exe anywhere inside the build folder we just made
          $exe = Get-ChildItem -Path . -Filter "*.exe" -Recurse | Where-Object { $_.FullName -like "*build*" } | Select-Object -First 1
          if ($exe) {
            Write-Host "Running: $($exe.FullName)"
            & $exe.FullName
          } else {
            Write-Host "Executable not found."
            exit 1
          }
        shell: powershell
