name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add Tools to PATH
        run: |
          "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # --- DEBUG STEP: This will show us exactly where the CMakeLists.txt is ---
      - name: Locate CMakeLists
        run: |
          Write-Host "Current Directory: $pwd"
          Write-Host "Searching for CMakeLists.txt..."
          Get-ChildItem -Path . -Filter "CMakeLists.txt" -Recurse
        shell: powershell

      - name: Generate build files
        run: |
          # We search for the directory containing CMakeLists.txt dynamically
          $cmakeDir = Get-ChildItem -Path . -Filter "CMakeLists.txt" -Recurse | Select-Object -First 1 -ExpandProperty DirectoryName

          if ($null -eq $cmakeDir) {
              Write-Error "Could not find CMakeLists.txt anywhere in the workspace!"
              exit 1
          }

          Write-Host "Found CMakeLists in: $cmakeDir"
          cd $cmakeDir

          # Clean and Build
          if (Test-Path build) { Remove-Item -Recurse -Force build }
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
          cmake --build build
        shell: powershell

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          # This looks for any .exe inside any build folder found
          path: "**/build/*.exe"
