name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add Tools to PATH
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # NEW DEBUG STEP: Run this to see where your files are!
      - name: Debug Directory Structure
        run: |
          Write-Host "--- CURRENT LOCATION ---"
          Get-Location
          Write-Host "--- LISTING ALL FILES IN WORKSPACE ---"
          Get-ChildItem -Recurse -Depth 2
          Write-Host "--- SEARCHING FOR CMAKELISTS.TXT ---"
          Get-ChildItem -Path C:\ -Filter "CMakeLists.txt" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
        shell: powershell

      - name: Generate build files with CMake
        run: |
          # 1. Find the file and FORCE the directory
          $cmakeFile = Get-ChildItem -Recurse -Filter "CMakeLists.txt" | Select-Object -First 1

          if ($cmakeFile) {
              $sourceDir = $cmakeFile.DirectoryName
              Write-Host "Found source at: $sourceDir"
              # Jump to that directory before running anything
              cd $sourceDir
          } else {
              Write-Error "CRITICAL: CMakeLists.txt not found. Check 'Debug Directory Structure' logs."
              exit 1
          }

          # 2. Clean build folder
          if (Test-Path "build") { Remove-Item -Recurse -Force -ErrorAction SilentlyContinue "build" }

          # 3. Use absolute paths to avoid any "relative path" confusion
          cmake -S "$sourceDir" -B "$sourceDir\build" -G "MinGW Makefiles" `
            -DCMAKE_C_COMPILER=gcc `
            -DCMAKE_CXX_COMPILER=g++ `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        shell: powershell

      - name: Build project
        run: |
          # Find where we put the build folder
          $buildDir = (Get-ChildItem -Recurse -Directory -Filter "build" | Select-Object -First 1).FullName
          cmake --build "$buildDir"
        shell: powershell

      - name: Run Clang-Tidy
        run: |
          $buildDir = (Get-ChildItem -Recurse -Directory -Filter "build" | Select-Object -First 1).FullName
          $files = Get-ChildItem -Path . -Include *.c,*.h -Recurse
          foreach ($file in $files) {
              clang-tidy $file.FullName -p "$buildDir" -checks="clang-analyzer-*,bugprone-*"
          }
        shell: powershell
