name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Add Tools to PATH
      - name: Add Tools to PATH
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # 3. Run Semgrep Naming Convention Scan
      - name: Run Semgrep Scan
        run: semgrep --config semgrep-naming-rules.yml
        continue-on-error: true

      # 4. Format Code
      - name: Run Clang Format
        run: |
          $files = Get-ChildItem -Path . -Include *.c,*.h -Recurse
          if ($files) {
              $files | ForEach-Object { clang-format -i $_.FullName }
          } else {
              Write-Host "No C or H files found to format."
          }
        shell: powershell

      # 5. Generate build files
      # We run this from the root where CMakeLists.txt is located.
      - name: Generate build files with CMake
        run: |
          if (Test-Path build) { Remove-Item -Recurse -Force build }

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_C_COMPILER=gcc `
            -DCMAKE_CXX_COMPILER=g++ `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        shell: powershell

      # 6. Build the project
      - name: Build project
        run: |
          cmake --build build
        shell: powershell

      # 7. Run Clang-Tidy
      # This uses the compile_commands.json created in Step 5
      - name: Run Clang-Tidy
        run: |
          $files = Get-ChildItem -Path . -Include *.c,*.h -Recurse
          if ($files) {
              foreach ($file in $files) {
                  Write-Host "Running clang-tidy on $($file.FullName)"
                  # -p build tells clang-tidy where to find the compilation database
                  clang-tidy $file.FullName -p build -checks="clang-analyzer-*,bugprone-*"
              }
          }
        shell: powershell

      # 8. Run the executable
      - name: Run executable
        run: |
          # Use a wildcard or specific name. Replace 'hello.exe' with your actual target name
          $exe = Get-ChildItem -Path build -Filter "*.exe" | Select-Object -First 1
          if ($exe) {
            Write-Host "Running $($exe.FullName)"
            & $exe.FullName
          } else {
            Write-Host "No executable found in build directory."
          }
        shell: powershell
