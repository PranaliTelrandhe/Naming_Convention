name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add Tools to PATH
        run: |
          "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # --- DEBUG STEP: This will show us exactly where the CMakeLists.txt is ---
      - name: Locate CMakeLists
        run: |
          Write-Host "Current Directory: $pwd"
          Write-Host "Searching for CMakeLists.txt..."
          Get-ChildItem -Path . -Filter "CMakeLists.txt" -Recurse
        shell: powershell

      - name: Debug and Build
        run: |
          # 1. List everything to see exactly where we are
          Write-Host "--- Checking Directory Structure ---"
          Get-ChildItem -Path . -Recurse -Filter "CMakeLists.txt" | Select-Object FullName

          # 2. Hard-change directory based on your log's "safe directory"
          # This matches the path Git revealed in your error log
          $targetPath = "Naming_Convention/Naming_Convention"

          if (Test-Path $targetPath) {
              cd $targetPath
              Write-Host "Switched to: $(Get-Location)"
          } else {
              Write-Host "Warning: $targetPath not found, staying in root."
          }

          # 3. Clean and Build
          if (Test-Path build) { Remove-Item -Recurse -Force build }

          # Explicitly verify CMakeLists exists here before running
          if (Test-Path "CMakeLists.txt") {
              cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
              cmake --build build
          } else {
              Write-Error "CRITICAL: CMakeLists.txt still not found in $(Get-Location)"
              exit 1
          }
        shell: powershell

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          # This looks for any .exe inside any build folder found
          path: "**/build/*.exe"
