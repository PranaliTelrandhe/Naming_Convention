name: Build C Project on Windows

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: [self-hosted, windows]

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Add Tools to PATH
      # Using GITHUB_PATH ensures tools are available for all following steps
      - name: Add Tools to PATH
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # 3. Run Semgrep Naming Convention Scan
      - name: Run Semgrep Scan
        run: semgrep --config semgrep-naming-rules.yml
        continue-on-error: true

      # 4. Format Code
      - name: Run Clang Format
        run: |
          $files = Get-ChildItem -Path . -Include *.c,*.h -Recurse
          if ($files) {
              $files | ForEach-Object { clang-format -i $_.FullName }
          } else {
              Write-Host "No C or H files found to format."
          }
        shell: powershell

      # 5. Generate build files
      # Logic: Move to workspace, wipe old build, and configure
      - name: Generate build files with CMake
        run: |
          cd $env:GITHUB_WORKSPACE

          # Clean build folder with error suppression (fixes self-hosted lock issues)
          if (Test-Path "build") { 
              Remove-Item -Recurse -Force -ErrorAction SilentlyContinue "build" 
          }

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_C_COMPILER=gcc `
            -DCMAKE_CXX_COMPILER=g++ `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        shell: powershell

      # 6. Build the project
      - name: Build project
        run: |
          cd $env:GITHUB_WORKSPACE
          cmake --build build
        shell: powershell

      # 7. Run Clang-Tidy
      - name: Run Clang-Tidy
        run: |
          cd $env:GITHUB_WORKSPACE
          $files = Get-ChildItem -Path . -Include *.c,*.h -Recurse
          if ($files) {
              foreach ($file in $files) {
                  Write-Host "Running clang-tidy on $($file.FullName)"
                  # -p build points to compile_commands.json
                  clang-tidy $file.FullName -p build -checks="clang-analyzer-*,bugprone-*"
              }
          }
        shell: powershell

      # 8. Run the executable
      - name: Run executable
        run: |
          cd $env:GITHUB_WORKSPACE
          $exe = Get-ChildItem -Path build -Filter "*.exe" -Recurse | Select-Object -First 1
          if ($exe) {
            Write-Host "Running $($exe.FullName)"
            & $exe.FullName
          } else {
            Write-Host "Error: No executable found in build directory."
            exit 1
          }
        shell: powershell
